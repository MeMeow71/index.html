<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>meow test</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: Arial, sans-serif;
        }

        body {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 20px;
        }

        .container {
            text-align: center;
            max-width: 500px;
            width: 100%;
            background: rgba(255, 255, 255, 0.1);
            padding: 25px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }

        h1 {
            margin-bottom: 20px;
            font-size: 2.2rem;
            color: #ffd700;
        }

        .status {
            font-size: 1.2rem;
            margin: 15px 0;
            font-weight: bold;
            min-height: 30px;
        }

        .players {
            display: flex;
            justify-content: space-around;
            margin: 15px 0;
            font-size: 1.1rem;
        }

        .player {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .symbol {
            width: 25px;
            height: 25px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.9rem;
        }

        .x .symbol { background: #ff6b6b; }
        .o .symbol { background: #51cf66; }

        .board {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin: 20px auto;
            max-width: 270px;
        }

        .cell {
            aspect-ratio: 1;
            background: rgba(255, 255, 255, 0.15);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid transparent;
        }

        .cell:hover {
            background: rgba(255, 255, 255, 0.25);
        }

        .cell.x { color: #ff6b6b; }
        .cell.o { color: #51cf66; }

        .winning-cell {
            background: rgba(255, 215, 0, 0.3) !important;
            border-color: gold !important;
        }

        .controls {
            margin: 20px 0 15px 0;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        button {
            padding: 12px;
            background: #ffa502;
            color: white;
            border: none;
            border-radius: 8px;
            padding-right: 1rem;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        button:hover {
            background: #ff7f00;
        }

        button:disabled {
            background: #cccccc;
            cursor: not-allowed;
        }

        .room-input {
            display: flex;
            gap: 8px;
            margin: 10px 0;
        }

        input {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            text-align: center;
        }

        .connection {
            margin: 10px 0;
            padding: 8px;
            border-radius: 5px;
            background: rgba(46, 213, 115, 0.3);
            font-size: 0.9rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>meow test</h1>
        
        <div class="status" id="status">–°–æ–∑–¥–∞–π—Ç–µ –∫–æ–º–Ω–∞—Ç—É</div>
        
        <div class="players">
            <div class="player x">
                <div class="symbol">X</div>
                <span id="playerX">...</span>
            </div>
            <div class="player o">
                <div class="symbol">O</div>
                <span id="playerO">...</span>
            </div>
        </div>
        
        <div class="connection" id="connection">–û–∂–∏–¥–∞–Ω–∏–µ</div>
        
        <div class="board" id="board"></div>
        
        <div class="controls">
            <div class="room-input">
                <input type="text" id="roomInput" placeholder="ID –∫–æ–º–Ω–∞—Ç—ã">
                <button id="joinBtn">–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è</button>
            </div>
            <button id="createBtn">–°–æ–∑–¥–∞—Ç—å –∫–æ–º–Ω–∞—Ç—É</button>
            <button id="newGameBtn">–ù–æ–≤–∞—è –∏–≥—Ä–∞</button>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>

    <script>
        // üîß –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø FIREBASE
        const firebaseConfig = {
            apiKey: "AIzaSyBGYBZUbXWA_4fqoO5aVLLPwWrztXyjcO8",
            authDomain: "rronoob-512ae.firebaseapp.com",
            databaseURL: "https://rronoob-512ae-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "rronoob-512ae",
            storageBucket: "rronoob-512ae.firebasestorage.app",
            messagingSenderId: "582568630469",
            appId: "1:582568630469:web:e9e8307e1d752bc7d7b8ac"
        };

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        let currentRoom = null;
        let playerId = 'player_' + Math.random().toString(36).substr(2, 9);
        let playerSymbol = null;
        let isMyTurn = false;

        // –≠–ª–µ–º–µ–Ω—Ç—ã DOM
        const statusElement = document.getElementById('status');
        const playerXElement = document.getElementById('playerX');
        const playerOElement = document.getElementById('playerO');
        const connectionElement = document.getElementById('connection');
        const boardElement = document.getElementById('board');
        const roomInput = document.getElementById('roomInput');
        const joinBtn = document.getElementById('joinBtn');
        const createBtn = document.getElementById('createBtn');
        const newGameBtn = document.getElementById('newGameBtn');

        // –°–æ–∑–¥–∞–Ω–∏–µ –¥–æ—Å–∫–∏
        function createBoard() {
            boardElement.innerHTML = '';
            for (let i = 0; i < 9; i++) {
                const cell = document.createElement('div');
                cell.className = 'cell';
                cell.setAttribute('data-index', i);
                cell.addEventListener('click', () => makeMove(i));
                boardElement.appendChild(cell);
            }
        }

        // –°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–º–Ω–∞—Ç—ã
        function createRoom() {
            const roomId = Math.random().toString(36).substr(2, 6).toUpperCase();
            roomInput.value = roomId;
            joinRoomHandler(roomId, true);
        }

        // –ü—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∫ –∫–æ–º–Ω–∞—Ç–µ
        function joinRoom() {
            const roomId = roomInput.value.trim().toUpperCase();
            if (!roomId) {
                alert('–í–≤–µ–¥–∏—Ç–µ ID –∫–æ–º–Ω–∞—Ç—ã');
                return;
            }
            joinRoomHandler(roomId, false);
        }

        function joinRoomHandler(roomId, isCreator) {
            const roomRef = database.ref('rooms/' + roomId);
            
            roomRef.once('value').then(snapshot => {
                if (!snapshot.exists() && !isCreator) {
                    alert('–ö–æ–º–Ω–∞—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
                    return;
                }

                currentRoom = roomId;
                connectionElement.textContent = '–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...';

                if (!snapshot.exists()) {
                    // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é –∫–æ–º–Ω–∞—Ç—É
                    roomRef.set({
                        players: { 
                            [playerId]: { symbol: 'X', name: '–ò–≥—Ä–æ–∫ 1' }
                        },
                        game: { 
                            board: ['','','','','','','','',''],
                            currentPlayer: 'X', 
                            winner: null
                        },
                        createdAt: Date.now()
                    });
                    playerSymbol = 'X';
                    isMyTurn = true;
                    statusElement.textContent = '–í–∞—à —Ö–æ–¥ (X)';
                } else {
                    // –ü—Ä–∏—Å–æ–µ–¥–∏–Ω—è–µ–º—Å—è –∫ –∫–æ–º–Ω–∞—Ç–µ
                    const room = snapshot.val();
                    const players = room.players || {};
                    
                    if (Object.keys(players).length >= 2) {
                        alert('–ö–æ–º–Ω–∞—Ç–∞ –∑–∞–ø–æ–ª–Ω–µ–Ω–∞');
                        return;
                    }

                    playerSymbol = 'O';
                    isMyTurn = false;
                    roomRef.child('players').update({
                        [playerId]: { symbol: 'O', name: '–ò–≥—Ä–æ–∫ 2' }
                    });
                    statusElement.textContent = '–û–∂–∏–¥–∞–µ–º —Ö–æ–¥ –ø—Ä–æ—Ç–∏–≤–Ω–∏–∫–∞';
                }

                setupRoomListeners(roomId);
            });
        }

        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–ª—É—à–∞—Ç–µ–ª–µ–π
        function setupRoomListeners(roomId) {
            const roomRef = database.ref('rooms/' + roomId);
            
            roomRef.on('value', snapshot => {
                const room = snapshot.val();
                if (room) {
                    updateBoard(room.game.board);
                    updatePlayers(room.players);
                    updateGameStatus(room.game);
                    connectionElement.textContent = '–ü–æ–¥–∫–ª—é—á–µ–Ω–æ';
                }
            });
        }

        // –•–æ–¥
        function makeMove(index) {
            if (!currentRoom || !isMyTurn) return;
            
            const gameRef = database.ref('rooms/' + currentRoom + '/game');
            gameRef.once('value').then(snapshot => {
                const game = snapshot.val();
                if (game && game.board[index] === '' && !game.winner) {
                    const newBoard = [...game.board];
                    newBoard[index] = playerSymbol;
                    
                    gameRef.update({
                        board: newBoard,
                        currentPlayer: playerSymbol === 'X' ? 'O' : 'X'
                    });
                }
            });
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–æ—Å–∫–∏
        function updateBoard(board) {
            const cells = document.getElementById('board').children;
            for (let i = 0; i < 9; i++) {
                cells[i].textContent = board[i] || '';
                cells[i].className = 'cell';
                if (board[i]) cells[i].classList.add(board[i].toLowerCase());
            }
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–≥—Ä–æ–∫–æ–≤
        function updatePlayers(players) {
            const playerX = Object.values(players).find(p => p.symbol === 'X');
            const playerO = Object.values(players).find(p => p.symbol === 'O');
            
            playerXElement.textContent = playerX ? playerX.name : '...';
            playerOElement.textContent = playerO ? playerO.name : '...';
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞
        function updateGameStatus(game) {
            const winner = checkWinner(game.board);
            isMyTurn = game.currentPlayer === playerSymbol && !winner;
            
            if (winner) {
                statusElement.textContent = winner === playerSymbol ? 
                    'üéâ –í—ã –ø–æ–±–µ–¥–∏–ª–∏!' : 'üòû –í—ã –ø—Ä–æ–∏–≥—Ä–∞–ª–∏';
                highlightWinner(game.board, winner);
            } else if (game.board.every(cell => cell !== '')) {
                statusElement.textContent = 'ü§ù –ù–∏—á—å—è!';
            } else {
                statusElement.textContent = isMyTurn ? 
                    '‚úÖ –í–∞—à —Ö–æ–¥!' : '‚è≥ –•–æ–¥ –ø—Ä–æ—Ç–∏–≤–Ω–∏–∫–∞';
            }
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–±–µ–¥–∏—Ç–µ–ª—è
        function checkWinner(board) {
            const wins = [[0,1,2],[3,4,5],[6,7,8],[0,3,6],[1,4,7],[2,5,8],[0,4,8],[2,4,6]];
            for (let win of wins) {
                if (board[win[0]] && board[win[0]] === board[win[1]] && board[win[0]] === board[win[2]]) {
                    return board[win[0]];
                }
            }
            return null;
        }

        // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –ø–æ–±–µ–¥–∏—Ç–µ–ª—è
        function highlightWinner(board, winner) {
            const wins = [[0,1,2],[3,4,5],[6,7,8],[0,3,6],[1,4,7],[2,5,8],[0,4,8],[2,4,6]];
            for (let win of wins) {
                if (board[win[0]] === winner && board[win[1]] === winner && board[win[2]] === winner) {
                    win.forEach(i => {
                        document.querySelector(`.cell[data-index="${i}"]`).classList.add('winning-cell');
                    });
                    break;
                }
            }
        }

        // –ù–æ–≤–∞—è –∏–≥—Ä–∞
        function newGame() {
            if (currentRoom) {
                database.ref('rooms/' + currentRoom + '/game').update({
                    board: ['','','','','','','','',''],
                    currentPlayer: 'X',
                    winner: null
                });
            } else {
                alert('–°–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞–π—Ç–µ –∫–æ–º–Ω–∞—Ç—É');
            }
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–Ω–æ–ø–æ–∫
        joinBtn.addEventListener('click', joinRoom);
        createBtn.addEventListener('click', createRoom);
        newGameBtn.addEventListener('click', newGame);

        // –ê–≤—Ç–æ–ø—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –ø–æ —Å—Å—ã–ª–∫–µ
        window.addEventListener('load', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const roomId = urlParams.get('room');
            if (roomId) {
                roomInput.value = roomId;
                setTimeout(() => joinRoomHandler(roomId, false), 1000);
            }
            createBoard();
        });
    </script>
</body>
</html>
